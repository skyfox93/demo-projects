<html>
<style>
	.image{width:500px;border-style:solid; border-width:5px;}
	#blurCanvas{display:none;}
	#canvas3{width:500px;}
	#greyCanvas{display:none;}
	#textdiv{background:grey;color:black;border-radius:40px;font-size:200%;text-align: center;}
	.small {font-size:0.5 em;}
	</style>

<body>

<div id=textdiv> <input type="file" name="file" id="file" accept="image/*"> </div>
<image src="1.jpg" id="image1" class="image"></image>
<canvas id="canvas3" width=900px height=620px></canvas>
<canvas id="greyCanvas" width=900px height=620px></canvas>
<canvas id="blurCanvas" width=900px height=620px></canvas>
<script src="./filter_scripts/blurFunction.js"></script>
<script>	
	
var image=document.getElementById('image1');
var blurCanvas=document.getElementById('blurCanvas');
var greyCanvas=document.getElementById('greyCanvas');
var canvas3=document.getElementById('canvas3');
var text=document.getElementById('textdiv');

var blurContext=blurCanvas.getContext('2d');
var greyContext=greyCanvas.getContext('2d');
var context3=canvas3.getContext('2d');
function handleFileSelect(evt) {
	if (document.getElementById('newImage')){document.body.removeChild(document.getElementById('newImage'));}
			var file = evt.target.files[0]; 
setTimeout(function(){image.src = window.URL.createObjectURL(file);},50); 
text.innerHTML="Opening Image";
}

document.getElementById('file').addEventListener('change', handleFileSelect, false);

image.onload=function(){ 
// REDUCE IMAGE SIZE to 8 MegaPixels IF image is larger than 8 megapixels
setTimeout(function(){
 let megaPix=image.naturalWidth*image.naturalHeight;
if(megaPix>5000000){
greyCanvas.width=image.naturalWidth*(5000000/megaPix);
greyCanvas.height=image.naturalHeight*(5000000/megaPix);}
else{
greyCanvas.width=image.naturalWidth; greyCanvas.height=image.naturalHeight;}

// Draw the image on the canvas	
greyContext.drawImage(image,0,0,greyCanvas.width,greyCanvas.height);
//Convert the image to black and white
greyContext.globalCompositeOperation="color";
greyContext.fillStyle="Gray";
greyContext.fillRect(0,0,greyCanvas.width,greyCanvas.height);
greyContext.globalCompositeOperation="source-over";
	
blurCanvas.width=greyCanvas.width/4;
blurCanvas.height=greyCanvas.height/4;

//SINCE WE ARE BLURING THIS, IT CAN BE SMALLER FOR PERFORMANCE
blurContext.drawImage(greyCanvas,0,0,blurCanvas.width,blurCanvas.height);

stackBlurImage('blurCanvas',30);// Blur the image
// Invert the blurred image
blurContext.globalAlpha=1;
blurContext.globalCompositeOperation="difference";blurContext.fillStyle="white";
blurContext.fillRect(0,0,blurCanvas.width,blurCanvas.height);
	
// CREATE MASK	
//greyContext.globalCompositeOperation="source-over"
//greyContext.globalAlpha=0.5;
//greyContext.drawImage(blurCanvas,0,0,greyCanvas.width,greyCanvas.height);
//greyContext.globalAlpha=1;
/// OVERLAY MASK ON NEW IMAGE
canvas3.width=greyCanvas.width;
canvas3.height=greyCanvas.height;
context3.globalAlpha=1;
context3.drawImage(image,0,0,canvas3.width,canvas3.height);
context3.globalCompositeOperation="overlay";
context3.globalAlpha=0.8;
context3.drawImage(blurCanvas,0,0,canvas3.width,canvas3.height);
context3.globalAlpha=0.5;
context3.drawImage(canvas3,0,0,canvas3.width,canvas3.height);
context3.globalCompositeOperation="source-over";

	// ADD SOME CONTRAST BACK IN
//context3.drawImage(image,0,0,greyCanvas.width,greyCanvas.height);
// RESTORE COLOR
//greyContext.globalCompositeOperation="color";
//greyContext.globalAlpha=1;
//greyContext.drawImage(image,0,0,greyCanvas.width,greyCanvas.height);

setTimeout(function(){var image=new Image();
image.src=canvas3.toDataURL("image/jpeg",1.0);image.id="newImage";image.className="image";document.body.appendChild(image);canvas3.style.display="none";text.innerHTML='Finished. Save Image with Right Click. <input type="file" name="file" id="file" accept="image/*">';
document.getElementById('file').addEventListener('change', handleFileSelect, false);},300);
text.innerHTML="Creating JPG.."
},500);
	 canvas3.style.display="inline-block";
	text.innerHTML="Editied Image will be on right";}




</script>



</body>
</html>